#!/usr/bin/make -f
# Sample debian/rules that uses debhelper. 
# GNU copyright 1997 by Joey Hess.
#
# This version is for a hypothetical package that builds an
# architecture-dependant package, as well as an architecture-independent
# package.

# Uncomment this to turn on verbose mode. 
#export DH_VERBOSE=1

# This is the debhelper compatability version to use.
export DH_COMPAT=2

configure: configure-stamp
configure-stamp:
	dh_testdir

	if [ configure.in -nt configure ]; then autoconf; fi
	./configure --prefix=/usr --mandir=\$${prefix}/share/man --infodir=\$${prefix}/share/info

	touch configure-stamp

build: build-stamp
build-stamp: configure-stamp
	dh_testdir

	# Add here commands to compile the package.
	$(MAKE) OFLAG=-O4

	touch build-stamp

clean:
	dh_testdir
	dh_testroot
	rm -f build-stamp configure-stamp

	-$(MAKE) clean

	dh_clean

install: DH_OPTIONS=
install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs

	$(MAKE) install DESTDIR=$$(pwd)/debian/tmp

	rm -rf debian/tmp/usr/share
	mkdir -p debian/tmp/usr/share/emacs/site-lisp
	cp -a $$(find debian/tmp/usr/local -name site-lisp -type d) debian/tmp/usr/share/emacs/site-lisp/gcl
	rm -rf debian/tmp/usr/local

	cat debian/tmp/usr/lib/gcl-2.5.0/gcl-tk/demos/index.lsp | \
		sed "s,$$(pwd)/debian/tmp,,1" >debian/foo
	mv debian/foo debian/tmp/usr/lib/gcl-2.5.0/gcl-tk/demos/index.lsp

	mkdir -p debian/tmp/usr/share/doc/gcl-doc/gcl-si.html
	cp info/gcl-si*html debian/tmp/usr/share/doc/gcl-doc/gcl-si.html/
	mkdir -p debian/tmp/usr/share/doc/gcl-doc/gcl-tk.html
	cp info/gcl-tk*html debian/tmp/usr/share/doc/gcl-doc/gcl-tk.html/

	rm -f debian/tmp/usr/bin/gcl.exe

	find debian/tmp -type f -name "*.lsp" -exec chmod -x {} \;
	find debian/tmp -type f -name "*.lisp" -exec chmod -x {} \;
	find debian/tmp -type f -name "*.el" -exec chmod -x {} \;
	find debian/tmp -type f -name "*.tcl" -exec chmod -x {} \;

	dh_movefiles

# Build architecture-independent files here.
# Pass -i to all debhelper commands in this target to reduce clutter.
binary-indep: build install
	dh_testdir -i
	dh_testroot -i
	dh_installdocs -i
	dh_installinfo -i
	cat debian/gcl-doc.postinst.debhelper | \
		sed -e 's/\(--quiet .*gcl-si\)/--section "GNU Common Lisp" "GNU Common Lisp" --description="GNU Common Lisp System Internals." \1/1' \
		    -e 's/\(--quiet .*gcl-tk\)/--section "GNU Common Lisp" "GNU Common Lisp" --description="GNU Common Lisp Tk Manual." \1/1' >debian/foo && \
		mv debian/foo debian/gcl-doc.postinst.debhelper
#	perl -pi -e 's/--quiet .*gcl-si/--section "GNU Common Lisp" "GNU Common Lisp" --description="GNU Common Lisp System Internals." $$&/; s/--quiet .*gcl-tk/--section "GNU Common Lisp" "GNU Common Lisp" --description="GNU Common Lisp Tk Manual." $$&/'  
	dh_installchangelogs ChangeLog -i
	dh_link -i
	dh_compress -i
	dh_fixperms -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i

# Build architecture-dependent files here.
binary-arch: build install
	dh_testdir -a
	dh_testroot -a
	dh_installdocs -a
	dh_installemacsen -a
	dh_installmanpages -a
	dh_installchangelogs ChangeLog -a
	dh_strip -a
	dh_link -a
	dh_compress -a
	dh_fixperms -a
	dh_installdeb -a
	dh_shlibdeps -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install configure

# vim:noet:nosta:nolist:
